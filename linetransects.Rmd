---
title: "linetransects"
author: "Diana Bowler"
date: "14 november 2017"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

Import the data - check the subsetting is as wanted

```{r}
library(knitr)
load("allData.RData")
head(allData)

```


Get population data

```{r, warning=FALSE}
library(magrittr)
library(plyr); library(dplyr)
library(ggplot2)

#subset
allData<-subset(allData,Year>2006 & Year<2018)

#remove hyphens for help with subsetting
allData$Fylkesnavn<-gsub("-"," ",allData$Fylkesnavn)
allData$Rapporteringsniva<-gsub("-"," ",allData$Rapporteringsniva)

#change kommune name for Dovre Fjellstyre
allData$Kommunenavn[which(allData$Kommunenavn=="Dovre Fjellstyrene")]<-"Dovre"
#Nordland__Indre Troms  Troms__Indre Troms 
allData$Fylkesnavn[which(allData$Rapporteringsniva=="Indre Troms")]<-"Troms"

#get number of individuals per line
nuIndivs <-
  allData%>%
  group_by(Year,LinjeID,Fylkesnavn,Kommunenavn,OmradeNavn,OmradeID,Rapporteringsniva, add = T) %>%
  summarise(nuAdults = sum(Adults), 
            nuJuvs = sum(AntallKylling),
            nuTotal = sum(totalIndiv),
            maxTransectLength=max(LengdeTaksert,na.rm=T))
nuIndivs$iYear <- nuIndivs$Year - min(nuIndivs$Year) + 1
summary(nuIndivs)

#reshape the line data into an array
library(reshape2)
nuIndivs$Line<-paste(nuIndivs$Fylkesnavn,nuIndivs$Rapporteringsniva,sep="_")
nuIndivs$Line<-paste(nuIndivs$Line,nuIndivs$OmradeID,sep="#")
nuIndivs$Line<-paste(nuIndivs$Line,nuIndivs$LinjeID,sep="-")
my.n <- acast(nuIndivs,Line~Year,value.var="nuTotal")

#check all have at least one positive and non-zero value
summary(as.numeric(apply(my.n,1,max,na.rm=T)))#yes!!

#get transect length data
#mistake with 1405 - transect length
allData$LengdeTaksert[which(allData$LinjeID==1405&allData$LengdeTaksert==1100)] <- 11000
allData$Line<-paste(allData$Fylkesnavn,allData$Rapporteringsniva,sep="_")
allData$Line<-paste(allData$Line,allData$OmradeID,sep="#")
allData$Line<-paste(allData$Line,allData$LinjeID,sep="-")
transectLengths <- acast(allData,Line~Year,value.var="LengdeTaksert",fun=max,na.rm=T)
transectLengths[is.na(my.n)]<-0
#there are some -1 transect lengths
#transectLengths[transectLengths==-1]<-0
#Finnmark_Indre Finnmark-882/3
my.n[transectLengths==0]<-NA

#order site info
siteInfo<-data.frame(Line=row.names(my.n))
siteInfo$Fylkesnavn<-as.numeric(factor(sapply(siteInfo$Line,function(x)strsplit(as.character(x),"_")[[1]][1])))
siteInfo$Rapporteringsniva<-as.numeric(factor(sapply(siteInfo$Line,function(x)strsplit(as.character(x),"#")[[1]][1])))
siteInfo$LinjeID<-as.numeric(factor(siteInfo$Line))
siteInfo$originalLinjeID<-sapply(siteInfo$Line,function(x)strsplit(as.character(x),"#")[[1]][2])
siteInfo$originalLinjeID<-sapply(siteInfo$originalLinjeID,function(x)strsplit(as.character(x),"-")[[1]][2])
siteInfo$Kommunenavn<-nuIndivs$Kommunenavn[match(siteInfo$originalLinjeID,nuIndivs$LinjeID)]

#Create a data frame with only detection
allDetections<-subset(allData,totalIndiv>0&!is.na(totalIndiv))
#get indices of sites
allDetections<-merge(allDetections[,-c(2:7)],siteInfo,by="Line",all.x=T,sort=FALSE)
allDetections$detectionLineYear<-
  as.numeric(factor(interaction(allDetections$LinjeID,allDetections$Year)))
allDetections$detectionSiteYear<-
  as.numeric(factor(interaction(allDetections$Rapporteringsniva,allDetections$Year)))

head(allDetections)
```


Compile for BUGS

```{r}

#Organise fur bugs
bugs.data <- list(#For the state model
                  n.Lines = length(unique(nuIndivs$LinjeID)),
                  n.Years = length(unique(nuIndivs$Year)),
                  n.Sites = length(unique(nuIndivs$Fylkesnavn)),
                  n.Sites2 = length(unique(interaction(nuIndivs$Rapporteringsniva,nuIndivs$Fylkesnavn))),
                  line = siteInfo$LinjeID,
                  site = siteInfo$Fylkesnavn,
                  site2 = siteInfo$Rapporteringsniva, 
                  year = (1:length(unique(nuIndivs$Year))),
                  NuIndivs = my.n,
                  TransectLength = transectLengths,#check again
                  #For the distance model
                  W = 200,
                  N = nrow(allDetections),
                  y = allDetections$LinjeAvstand,
                  detectionGroupSize = log(allDetections$totalIndiv+1),
                  GroupSize = allDetections$totalIndiv,
                  zeros.dist = rep(0,nrow(allDetections)),
                  detectionLine = allDetections$LinjeID,
                  detectionYear = as.numeric(as.factor(allDetections$Year)),
                  detectionSite = allDetections$Rapporteringsniva,
                  detectionSiteYear = allDetections$detectionSiteYear)

#add lengths
bugs.data$n.LineYear<-length(unique(bugs.data$detectionLineYear))
bugs.data$n.SiteYear<-length(unique(bugs.data$detectionSiteYear))

names(bugs.data)

```

Run model in JAGS (first time only)

```{r}

source('C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/bugsFunctions.R')
params <- c("int.d","line.d.sd","year.d.sd","Density")

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/models")
out1 <- jags(bugs.data, inits=NULL, params, "linetransectModel.txt", n.thin=nt,
               n.chains=nc, n.burnin=2000,n.iter=10000,parallel=T)

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs")
#save(out1,file="out1_linetransectModel.RData")#simple group size model(year and site)
#save(out1,file="out1_linetransectModel_2.RData")#re-run with more complicated model
traceplot(out1)

```

Get model fits

```{r}

source('C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/bugsFunctions.R')
load("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs/out1_linetransectModel_2.RData")
load("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/siteInfo.RData")

print(out1$summary,2)

fits<-getBUGSFits(out1)

#get average values per year
fits<-ddply(fits,.(Line,Fylkesnavn,Rapporteringsniva,originalLinjeID),summarise,mean=mean(mean))

summary(fits$mean)

#int.d is 7.5 ptarmigan per km squared

```

Make lines spatial

```{r}

load("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/Temp_2_linetransect_coords.RData")

Temp_2<-subset(Temp_2,LinjeID%in%unique(allData$LinjeID))

library(sp)
library(rgeos)

LongLat = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84")

for (i in seq(nrow(Temp_2))) {
  if (i == 1) {
    spTemp = readWKT(Temp_2$STAsText[i], Temp_2$LinjeID[i], p4s=LongLat)
    
  }
  else {
    spTemp = rbind(
      spTemp, readWKT(Temp_2$STAsText[i], Temp_2$LinjeID[i], p4s=LongLat)
      
    )
  }
}

#Make Lines spatial data frame
mydata <- Temp_2[,c("LinjeID","Fylkesnavn","Region","Rapporteringsniva","OmradeID", "OmradeNavn")]
rownames(mydata) <- paste(mydata$LinjeID)
Lines_spatial <- SpatialLinesDataFrame(spTemp, mydata, match.ID=T)
plot(Lines_spatial)


```

Plot predictions based on transect coordinates

```{r}
library(sp)
library(ggplot2)

mySLDF_fortify<-fortify(Lines_spatial)
mySLDF_fortify$fits<-fits$mean[match(mySLDF_fortify$id,fits$originalLinjeID)]
ggplot(mySLDF_fortify, aes(x=long, y=lat, group=group)) + 
  geom_path(aes(colour=log(fits)),size=rel(4),alpha=0.5) +
  scale_colour_gradient(low="red",high="steelblue")+
  theme_classic()

```

#Aline transects with the grid

for this we use birds with point observations

(1) First do quality check on the points

```{r}

#get all observations
allDataObs<-subset(allData,!is.na(totalIndiv))
allDataObs<-subset(allDataObs,totalIndiv!=0)

#Remove obs without coords
allDataObs<-subset(allDataObs,!is.na(Latitude))
allDataObs<-subset(allDataObs,Latitude!=0)
summary(allDataObs$Latitude)
summary(allDataObs$Longitude)
 
#Remove obs whose coords differ from predicted coords by 500m
allDataObs$diff<-abs(allDataObs$LinjeAvstand-allDataObs$N_dist)
hist(allDataObs$diff)
summary(allDataObs$diff)
allDataObs<-subset(allDataObs,diff<=500)

#make into a spatial object
coordinates(allDataObs)<-c("Longitude","Latitude")
plot(allDataObs)

```

(2) Assign points to the grid

```{r}

#get Norway
library(raster)
library(maptools)
data(wrld_simpl)
Norway<- subset(wrld_simpl,NAME=="Norway")
Norway <- gBuffer(Norway,width=1)
plot(Norway)

#create grid
newres=0.05
mygrid<-raster(extent(Norway))
res(mygrid)<-newres
mygrid[]<-1:ncell(mygrid)
plot(mygrid)
gridTemp<-mygrid

#get presences
allDataObs$grid<-extract(mygrid,allDataObs)

```

(3) Work about how much each grid was covered by a line transect

```{r, results='asis'}

library(rgeos)
projection(mygrid)<-crs(Lines_spatial)#they are both in lon lat
rsp <- rasterToPolygons(mygrid)

#convert into a m grid
rsp <-spTransform(rsp,CRS("+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"))
Lines_spatial <-spTransform(Lines_spatial,CRS("+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"))

#get overlap
rp <- raster::intersect(Lines_spatial,rsp)
rp$length <- gLength(rp, byid=TRUE) 
mapping<-rp

head(rp)
#  LinjeID           Fylkesnavn   Region Rapporteringsniva OmradeID OmradeNavn  layer    length
#1     122 Oppland              Statskog         Kongsvoll      285    Gåvålia 111645 3680.0004
#2      93 Oppland              Statskog         Kongsvoll      286  Kongsvoll 111642 2221.2015
#3      93 Oppland              Statskog         Kongsvoll      286  Kongsvoll 111643 1520.0632
#4     103 Oppland              Statskog         Kongsvoll      286  Kongsvoll 111074 2330.2495
#5     103 Oppland              Statskog         Kongsvoll      286  Kongsvoll 111075  963.9436
#6    1389 Oppland              Statskog         Kongsvoll      286  Kongsvoll 111643 2450.0003

#checking this works
rp2<-subset(rp,LinjeID==103)
rsp2<-subset(rsp,layer%in%c("111074","111075"))
plot(rsp2)
plot(rp2,add=T)#seem to overlap 2 cells indeed

#are there any cells overlapped more than 2 cells
#rpTot<-ddply(rp@data,.(LinjeID),summarise,nuCells=length(unique(layer)))

#LinjeID nuCells
#400       6
#rp2<-subset(rp,LinjeID==400)
#rsp2<-subset(rsp,layer%in%rp2@data$layer)
#plot(rsp2)
#plot(rp2,add=T)#seem to overlap 6 cells indeed -but its not in a straight line

#get total length per grid cell
rp<-ddply(rp@data,.(layer),summarise,length=sum(length))
summary(rp$length)

#plot it
mygrid[]<-0
mygrid[rp$layer]<-rp$length
plot(mygrid)

#turn into an array
transectLengths<-expand.grid(grid=rp$layer,Year=2007:2017)
transectLengths$length<-rp$length[match(transectLengths$grid,rp$layer)]
transectLengths$LinjeID<-mapping$LinjeID[match(transectLengths$grid,mapping$layer)]

#add zeros for transect lengths... when when a line wasnt visited in a year
allSurveys<-unique(allData[!is.na(allData$TakseringID),c("Year","LinjeID")])
transectLengths$Ran<-interaction(transectLengths$Year,transectLengths$LinjeID) %in% interaction(allSurveys$Year,allSurveys$LinjeID)
transectLengths$length[transectLengths$Ran==FALSE]<-0

#cast into an array
tlDF<-transectLengths
transectLengths<-acast(tlDF,grid~Year,value.var="length")

```

(4) Insert NAs into the datasheet

```{r}

head(allDataObs)
head(tlDF)

#Get statistics per year and grid
obsDF<-ddply(allDataObs@data,.(grid,Year),summarise,
                   nuGroups=length(totalIndiv),
                   totalsInfo=sum(totalIndiv),
                   groupsize=mean(totalIndiv))


#add info to the transects data frame
tlDF<-merge(tlDF,obsDF,by=c("grid","Year"),all.x=T)

#add zeros for when there was a transect but nothing was seen
tlDF$nuGroups[is.na(tlDF$nuGroups) & (tlDF$length>0)]<-0
tlDF$totalsInfo[is.na(tlDF$totalsInfo) & (tlDF$length>0)]<-0

#cast into arrays
library(reshape2)
groupInfo <- acast(tlDF,grid~Year,value.var="nuGroups")
totalsInfo<-acast(tlDF,grid~Year,value.var="totalsInfo")
groupSizes<-acast(tlDF,grid~Year,value.var="groupsize")

#check data frames now match
all(row.names(groupInfo)==row.names(transectLengths))
all(row.names(totalsInfo)==row.names(transectLengths))
all(row.names(groupSizes)==row.names(transectLengths))

#put NAs where transect length is zero
groupInfo[transectLengths==0]<-NA
totalsInfo[totalsInfo==0]<-NA

```


(5) Reorganise data at the grid level

```{r}

#get site Info all grids
siteInfo<-unique(allDataObs@data[,c("LinjeID","Fylkesnavn","Rapporteringsniva")])
allgrids<-unique(tlDF[,c("grid","LinjeID")])
siteInfo<-merge(siteInfo,allgrids,by=c("LinjeID"))
siteInfo<-siteInfo[order(siteInfo$grid),]

#add site factor indices
all(row.names(transectLengths)==siteInfo$grid)
siteInfo$gridIndex<-as.numeric(as.factor(siteInfo$grid))
siteInfo$RapporteringsnivaN<-as.numeric(factor(siteInfo$Rapporteringsniva))
siteInfo$FylkesnavnN<-as.numeric(factor(siteInfo$Fylkesnavn))

#to have it renamed as a specific object
siteInfo_LineTransects<-siteInfo

#add the indices to the detection object
allDetections<-allDataObs
allDetections$gridIndex<-siteInfo$gridIndex[match(allDetections$grid,siteInfo$grid)]
allDetections$RapporteringsnivaN<-siteInfo$RapporteringsnivaN[match(allDetections$grid,siteInfo$grid)]

bugs.data <- list(#For the state model
                  n.Lines = length(unique(siteInfo$grid)),
                  n.Years = length(unique(allData$Year)),
                  n.Sites = length(unique(siteInfo$Fylkesnavn)),
                  n.Sites2 = length(unique(siteInfo$Rapporteringsniva)),
                  line = siteInfo$gridIndex,
                  site = siteInfo$FylkesnavnN,
                  site2 = siteInfo$RapporteringsnivaN, 
                  year = (1:length(unique(allData$Year))),
                  NuIndivs = groupInfo,
                  TransectLength = transectLengths,
                  #For the distance model
                  W = 200,
                  N = nrow(allDetections),
                  y = allDetections$LinjeAvstand,
                  detectionGroupSize = log(allDetections$totalIndiv+1),
                  GroupSize = allDetections$totalIndiv,
                  zeros.dist = rep(0,nrow(allDetections)),
                  n.LineD = length(unique(allDetections$grid)),
                  detectionLine = allDetections$gridIndex,
                  detectionYear = as.numeric(as.factor(allDetections$Year)),
                  detectionSite = allDetections$RapporteringsnivaN)


names(bugs.data)

```

(6) Run new model at the grid level

```{r}

source('C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/bugsFunctions.R')
params <- c("int.d","line.d.sd","year.d.sd","Density")

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/models")
out1 <- jags(bugs.data, inits=NULL, params, "linetransectModel.txt", n.thin=nt,
               n.chains=3, n.burnin=1000,n.iter=5000,parallel=T)

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs")
save(out1,file="out1_linetransectModel_Gridded.RData")
traceplot(out1)

```

Look at fits

```{r}
load("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs/out1_linetransectModel_Gridded.RData")
fits<-getBUGSFits(out1)
mygrid[]<-0
mygrid[fits$layer]<-fits$mean
plot(mygrid)

```

Get approximate transect coverage of each cell
ESW is about 115m

```{r}
library(Rdistance)
fit <- F.dfunc.estim(bugs.data$y, likelihood="halfnorm")#effective strip width is 118 m
plot(fit)

#add a buffer to all lines
#get overlap
plot(rsp)
plot(Lines_spatial,add=T)

#add buffer to the lines
Line_spatial_Buffered<-gBuffer(Lines_spatial,byid=TRUE,width=115)
gIntersection(Line_spatial_Buffered,rsp,byid=TRUE)

sapply(Lines_spatial_buffered,function(x))


rp <- raster::intersect(Lines_spatial,rsp)


```


Fit a detection only model
```{r}
source('C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/bugsFunctions.R')

params <- c("b.df.0","b.group.size","predESW")

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/models")
out1 <- jags(bugs.data, inits=NULL, params, "linetransectModel_detection.txt", n.thin=nt,
               n.chains=3, n.burnin=1000,n.iter=5000,parallel=T)

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs")
save(out1,file="out1_linetransectModel_detection.RData")
traceplot(out1)

```

Get effective strip widths:

```{r}
setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs")
load("out1_linetransectModel_detection.RData")
summary(out1$mean$predESW)
esw<-getBUGSFits(out1,param="predsESW")
```

Now get the environmental information for these cells

```{r}
load("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/varDF_allEnvironData_5km.RData")

varDF<-unique(varDF)
siteInfo<-merge(siteInfo,varDF,by.x="layer",by.y="grid",all.x=T,sort=FALSE)

#add new variables to the bugs data
bugs.data$occDM <- model.matrix(~ as.numeric(scale(siteInfo$bio1)) +
                                  as.numeric(scale(siteInfo$Open)) +
                                  as.numeric(scale(siteInfo$tree_line_position)) +
                                  as.numeric(scale(siteInfo$tree_line_position^2)))[,-1]
bugs.data$n.covs <- ncol(bugs.data$occDM)

```


get effective strip widths
```{r}
setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs")
load("esw.RData")

#add to the bugs data object
bugs.data$ESW.mean <- acast(esw,lineIndex~Year,value.var="mean")
bugs.data$ESW.sd <- acast(esw,lineIndex~Year,value.var="sd")

```

Run model:

```{r}

source('C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/bugsFunctions.R')
params <- c("int","line.d.sd","beta")

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/models")
out1 <- jags(bugs.data, inits=NULL, params, "linetransectModel_variables.txt", n.thin=nt,
               n.chains=3, n.burnin=1000,n.iter=5000,parallel=T)

setwd("C:/Users/diana.bowler/OneDrive - NINA/Alpine/ptarmiganUpscaling/model-outputs")
#save(out1,file="out1_linetransectModel_Gridded_variables.RData")
traceplot(out1)

```



