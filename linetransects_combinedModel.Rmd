---
title: "linetransects"
author: "Diana Bowler"
date: "14 november 2017"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

Import the data - check the subsetting is as wanted

```{r}

library(knitr)
load("data/allData.RData")
head(allData)

sum(allData$totalIndiv,na.rm=T)#76105

```


Get population data

```{r, warning=FALSE}
library(magrittr)
library(plyr); library(dplyr)
library(ggplot2)

#subset
allData<-subset(allData,Year>2006 & Year<2018)

#remove hyphens for help with subsetting
allData$Fylkesnavn<-gsub("-"," ",allData$Fylkesnavn)
allData$Rapporteringsniva<-gsub("-"," ",allData$Rapporteringsniva)

#change kommune name for Dovre Fjellstyre
allData$Kommunenavn[which(allData$Kommunenavn=="Dovre Fjellstyrene")]<-"Dovre"
#Nordland__Indre Troms  Troms__Indre Troms 
allData$Fylkesnavn[which(allData$Rapporteringsniva=="Indre Troms")]<-"Troms"

#get number of individuals per line
nuIndivs <-
  allData%>%
  group_by(Year,LinjeID,Fylkesnavn,Kommunenavn,OmradeNavn,OmradeID,Rapporteringsniva, add = T) %>%
  summarise(nuAdults = sum(Adults), 
            nuJuvs = sum(AntallKylling),
            nuTotal = sum(totalIndiv),
            maxTransectLength=max(LengdeTaksert,na.rm=T))
nuIndivs$iYear <- nuIndivs$Year - min(nuIndivs$Year) + 1
summary(nuIndivs)

#reshape the line data into an array
library(reshape2)
nuIndivs$Line<-paste(nuIndivs$Fylkesnavn,nuIndivs$Rapporteringsniva,sep="_")
nuIndivs$Line<-paste(nuIndivs$Line,nuIndivs$OmradeID,sep="#")
nuIndivs$Line<-paste(nuIndivs$Line,nuIndivs$LinjeID,sep="-")
my.n <- acast(nuIndivs,Line~Year,value.var="nuTotal")

#check all have at least one positive and non-zero value
summary(as.numeric(apply(my.n,1,max,na.rm=T)))#yes!!

#get transect length data
#mistake with 1405 - transect length
allData$LengdeTaksert[which(allData$LinjeID==1405&allData$LengdeTaksert==1100)] <- 11000
allData$Line<-paste(allData$Fylkesnavn,allData$Rapporteringsniva,sep="_")
allData$Line<-paste(allData$Line,allData$OmradeID,sep="#")
allData$Line<-paste(allData$Line,allData$LinjeID,sep="-")
transectLengths <- acast(allData,Line~Year,value.var="LengdeTaksert",fun=max,na.rm=T)
transectLengths[is.na(my.n)]<-0
#there are some -1 transect lengths
#transectLengths[transectLengths==-1]<-0
#Finnmark_Indre Finnmark-882/3
my.n[transectLengths==0]<-NA

#order site info
siteInfo<-data.frame(Line=row.names(my.n))
siteInfo$Fylkesnavn<-as.numeric(factor(sapply(siteInfo$Line,function(x)strsplit(as.character(x),"_")[[1]][1])))
siteInfo$Rapporteringsniva<-as.numeric(factor(sapply(siteInfo$Line,function(x)strsplit(as.character(x),"#")[[1]][1])))
siteInfo$LinjeID<-as.numeric(factor(siteInfo$Line))
siteInfo$originalLinjeID<-sapply(siteInfo$Line,function(x)strsplit(as.character(x),"#")[[1]][2])
siteInfo$originalLinjeID<-sapply(siteInfo$originalLinjeID,function(x)strsplit(as.character(x),"-")[[1]][2])
siteInfo$Kommunenavn<-nuIndivs$Kommunenavn[match(siteInfo$originalLinjeID,nuIndivs$LinjeID)]

#Create a data frame with only detection
allDetections<-subset(allData,totalIndiv>0&!is.na(totalIndiv))
#get indices of sites
allDetections<-merge(allDetections[,-c(2:7)],siteInfo,by="Line",all.x=T,sort=FALSE)
allDetections$detectionLineYear<-
  as.numeric(factor(interaction(allDetections$LinjeID,allDetections$Year)))
allDetections$detectionSiteYear<-
  as.numeric(factor(interaction(allDetections$Rapporteringsniva,allDetections$Year)))

head(allDetections)
```


Compile for BUGS

```{r}

#Organise fur bugs
bugs.data <- list(#For the state model
                  n.Lines = length(unique(nuIndivs$LinjeID)),
                  n.Years = length(unique(nuIndivs$Year)),
                  n.Sites = length(unique(nuIndivs$Fylkesnavn)),
                  n.Sites2 = length(unique(interaction(nuIndivs$Rapporteringsniva,nuIndivs$Fylkesnavn))),
                  line = siteInfo$LinjeID,
                  site = siteInfo$Fylkesnavn,
                  site2 = siteInfo$Rapporteringsniva, 
                  year = (1:length(unique(nuIndivs$Year))),
                  NuIndivs = my.n,
                  TransectLength = transectLengths,#check again
                  #For the distance model
                  W = 200,
                  N = nrow(allDetections),
                  y = allDetections$LinjeAvstand,
                  detectionGroupSize = log(allDetections$totalIndiv+1),
                  GroupSize = allDetections$totalIndiv,
                  zeros.dist = rep(0,nrow(allDetections)),
                  detectionLine = allDetections$LinjeID,
                  detectionYear = as.numeric(as.factor(allDetections$Year)),
                  detectionSite = allDetections$Rapporteringsniva,
                  detectionSiteYear = allDetections$detectionSiteYear)

#add lengths
bugs.data$n.LineYear<-length(unique(bugs.data$detectionLineYear))
bugs.data$n.SiteYear<-length(unique(bugs.data$detectionSiteYear))

names(bugs.data)

```

Make transect lines a spatial object

```{r}

load("data/Temp_2_linetransect_coords.RData")

Temp_2<-subset(Temp_2,LinjeID%in%unique(allData$LinjeID))

library(sp)
library(rgeos)

LongLat = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84")

for (i in seq(nrow(Temp_2))) {
  if (i == 1) {
    spTemp = readWKT(Temp_2$STAsText[i], Temp_2$LinjeID[i], p4s=LongLat)
    
  }
  else {
    spTemp = rbind(
      spTemp, readWKT(Temp_2$STAsText[i], Temp_2$LinjeID[i], p4s=LongLat)
      
    )
  }
}

#Make Lines spatial data frame
mydata <- Temp_2[,c("LinjeID","Fylkesnavn","Region","Rapporteringsniva","OmradeID", "OmradeNavn")]
rownames(mydata) <- paste(mydata$LinjeID)
Lines_spatial <- SpatialLinesDataFrame(spTemp, mydata, match.ID=T)
plot(Lines_spatial)


```

Aline line transects with the spatial grid

for this we use birds with point observations

(1) First do quality check on the points

```{r}

#get all observations
allDataObs<-subset(allData,!is.na(totalIndiv))
allDataObs<-subset(allDataObs,totalIndiv!=0)

#Remove obs without coords
allDataObs<-subset(allDataObs,!is.na(Latitude))
allDataObs<-subset(allDataObs,Latitude!=0)
summary(allDataObs$Latitude)
summary(allDataObs$Longitude)
 
#Remove obs whose coords differ from predicted coords by 500m
allDataObs$diff<-abs(allDataObs$LinjeAvstand-allDataObs$N_dist)
hist(allDataObs$diff)
summary(allDataObs$diff)
allDataObs<-subset(allDataObs,diff<=500)

#make into a spatial object
coordinates(allDataObs)<-c("Longitude","Latitude")
plot(allDataObs)

```

(2) Assign points (i.e.., observations of birds along the transects) to the grid

```{r}

#using a m grid
equalM<-"+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"


#get Norway
library(raster)
library(maptools)
data(wrld_simpl)
Norway<- subset(wrld_simpl,NAME=="Norway")
Norway <- gBuffer(Norway,width=1)
Norway<-spTransform(Norway,crs(equalM))
plot(Norway)

#create grid
newres=5000#5 km grid
mygrid<-raster(extent(projectExtent(Norway,equalM)))
res(mygrid)<-newres
mygrid[]<-1:ncell(mygrid)
plot(mygrid)
summary(getValues(mygrid))
gridTemp<-mygrid

#convert observations to this CRS as well
proj4string(allDataObs) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")
allDataObs <- sp::spTransform(allDataObs, crs(equalM))

#plot
plot(mygrid)
plot(Norway,add=T)
plot(allDataObs,add=T)

#get presences
allDataObs$grid<-extract(mygrid,allDataObs)

sum(allDataObs$totalIndiv,na.rm=T)#63705

```

(3) Work about how much each grid was covered by a line transect

```{r, results='asis'}

library(rgeos)
projection(mygrid)<-CRS(equalM)
rsp <- rasterToPolygons(mygrid)

#convert into a m grid
Lines_spatial <-spTransform(Lines_spatial,CRS("+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"))

#get overlap
rp <- raster::intersect(Lines_spatial,rsp)
rp$length <- gLength(rp, byid=TRUE) 
mapping<-rp

head(rp)
#  LinjeID           Fylkesnavn   Region Rapporteringsniva OmradeID OmradeNavn layer    length
#1     122 Oppland              Statskog         Kongsvoll      285    G책v책lia 67334 2970.6538
#2     122 Oppland              Statskog         Kongsvoll      285    G책v책lia 67633  709.3467
#3      93 Oppland              Statskog         Kongsvoll      286  Kongsvoll 67631 1936.0229
#4      93 Oppland              Statskog         Kongsvoll      286  Kongsvoll 67632 1805.2418
#5     103 Oppland              Statskog         Kongsvoll      286  Kongsvoll 67333 3294.1931
#6    1389 Oppland              Statskog         Kongsvoll      286  Kongsvoll 67333 1740.6537

#checking this works
#rp2<-subset(rp,LinjeID==122)
#rsp2<-subset(rsp,layer%in%c("67334","67633"))
#plot(rsp2)
#plot(rp2,add=T)#seem to overlap 2 cells indeed

#rp2<-subset(rp,LinjeID==122)
#rsp2<-subset(rsp,layer%in%c("67334","67633"))
#plot(rsp2)
#plot(rp2,add=T)#seem to overlap 2 cells indeed

#get information on each year in which each grid was sampled
allSurveys<-unique(allData[!is.na(allData$TakseringID),c("Year","LinjeID")])
rp<-merge(allSurveys,rp@data,by=c("LinjeID"),all.x=T)
newgrid<-expand.grid(Year=sort(unique(rp$Year)), layer=unique(rp$layer))
rp<-merge(newgrid,rp,by=c("Year","layer"),all.x=T)

#get total length per grid cell per year
transectLengths<-ddply(rp,.(layer,Year),summarise,length=sum(length,na.rm=T))
transectLengths<-arrange(transectLengths,Year,layer)
summary(transectLengths$length)

#cast into an array
tlDF<-transectLengths
names(tlDF)[1]<-"grid"
transectLengths<-acast(tlDF,grid~Year,value.var="length")
transectLengths[1:10,1:10]

```

(4) Bring all data together at the grid level

```{r}

head(allDataObs)
head(tlDF)

#Get statistics per year and grid
obsDF<-ddply(allDataObs@data,.(grid,Year),summarise,
                   nuGroups=length(totalIndiv),
                   totalsInfo=sum(totalIndiv),
                   groupsize=mean(totalIndiv))

#sum(obsDF$totalsInfo,na.rm=T)
#[1] 63705

#identify cells in which nothing was ever seen
#out<-ddply(obsDF,.(grid),summarise,totalObs=sum(totalsInfo))
#there are none

#add info to the transects data frame
tlDF<-merge(tlDF,obsDF,by=c("grid","Year"),all.x=T)
#sum(tlDF$totalsInfo,na.rm=T)
#[1] 63584


```


(4) Insert NAs into the datasheet (i.e., include grids where there has no line transect) - enabling model predictions to the full grid 

```{r}

#add all the grids we wish to impute for

#should be in the same order as the ArtsDatenBank data
head(siteInfo_ArtsDaten)

newgrid<-expand.grid(Year=unique(tlDF$Year),
                      grid=unique(siteInfo_ArtsDaten$grid))
tlDF<-merge(tlDF,newgrid,by=c("Year","grid"),all.y=T)

#add site index data
tlDF$siteIndex <- siteInfo_ArtsDaten$siteIndex[match(tlDF$grid,siteInfo_ArtsDaten$grid)]
tlDF<-arrange(tlDF,siteIndex,Year)

#add zero transect length info
tlDF$length[is.na(tlDF$length)]<-0

#plot where we have data
dataPresent <- subset(myGridDF,layer%in%tlDF$grid[!is.na(tlDF$totalsInfo)])
qplot(x,y,data=dataPresent)

```

Get site info data for the line transect data only

```{r}

#get site Info all grids
siteInfo <- unique(tlDF[,c("grid","siteIndex")])
siteInfo$admN <- siteInfo_ArtsDaten$admN[match(siteInfo$grid,siteInfo_ArtsDaten$grid)]
siteInfo$admN2 <- siteInfo_ArtsDaten$admN2[match(siteInfo$grid,siteInfo_ArtsDaten$grid)]

#to have it renamed as a specific object
siteInfo_LineTransects<-siteInfo

```

Also, add zeros for when there was a transect in a grid but nothing was seen

```{r}

tlDF$nuGroups[is.na(tlDF$nuGroups) & (tlDF$length>0)]<-0
tlDF$totalsInfo[is.na(tlDF$totalsInfo) & (tlDF$length>0)]<-0
tlDF$nuGroups[tlDF$length==0]<-NA
tlDF$totalsInfo[tlDF$length==0]<-NA

#cast into arrays
library(reshape2)
groupInfo <- acast(tlDF,siteIndex~Year,value.var="nuGroups")
totalsInfo<-acast(tlDF,siteIndex~Year,value.var="totalsInfo")
groupSizes<-acast(tlDF,siteIndex~Year,value.var="groupsize")
transectLengths<-acast(tlDF,siteIndex~Year,value.var="length")

#put NAs where transect length is zero
groupInfo[transectLengths==0]<-NA
totalsInfo[transectLengths==0]<-NA

#sum(as.numeric(totalsInfo),na.rm=T)
#[1] 63584

#check alignment with other datasets
all(row.names(groupInfo)==siteInfo_ArtsDaten$siteIndex)
all(row.names(groupInfo)==listlengthDF_SiteCovs$siteIndex)

```

(5) Get detection data for each grid

```{r}
#add the indices to the detection object
allDetections<-allDataObs
allDetections$siteIndex<-siteInfo_ArtsDaten$siteIndex[match(allDetections$grid,siteInfo_ArtsDaten$grid)]

allDetections$RapporteringsnivaN<-siteInfo_LineTransects$RapporteringsnivaN[match(allDetections$grid,siteInfo_LineTransects$grid)]

#remove those not overlapping with a grid
allDetections<-subset(allDetections,!is.na(siteIndex))
```

(6) Re-organise as a bugs model - now at the grid-level  

```{r}

bugs.data <- list(#For the state model
                  n.grid = length(unique(siteInfo_ArtsDaten$grid)),
                  n.year = length(unique(allData$Year)),
                  n.adm = length(unique(siteInfo$admN)),
                  n.adm2 = length(unique(siteInfo$admN2)),
                  grid = siteInfo$siteIndex,
                  adm = siteInfo$admN,
                  adm2 = siteInfo$admN2, 
                  year = (1:length(unique(allData$Year))),
                  NuIndivs = totalsInfo,
                  TransectLength = transectLengths,
                  #For the distance model
                  W = 200,
                  N = nrow(allDetections),
                  y = allDetections$LinjeAvstand,
                  ln_GroupSize = log(allDetections$totalIndiv+1),
                  GroupSize = allDetections$totalIndiv,
                  zeros.dist = rep(0,nrow(allDetections)))


names(bugs.data)

bugs.data_LineTransects <- bugs.data 

```
